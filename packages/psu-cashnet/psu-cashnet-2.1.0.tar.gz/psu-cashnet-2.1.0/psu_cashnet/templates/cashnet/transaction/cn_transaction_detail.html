{% extends 'psu_base/layout/main.html' %}
{% load base_taglib %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{%block title%}Cashnet Transaction #{{tx.id}}{%endblock%}}</title>
    {% block scripts %}
    {% endblock %}
</head>
<body>
    {% block breadcrumbs %}
        <a href="{%url 'cashnet:transaction_index'%}">Transaction List</a>
        &rsaquo;
        <a href="{%url 'cashnet:transaction_detail' tx.id%}" class="active">Transaction #{{tx.id}}</a>
    {% endblock %}
    {% block pagecontent %}

    <h1>Cashnet Transaction #{{tx.id}}</h1>

    <table class="table table-striped table-hover table-condensed" id="transaction_table">
        <tr>
            <th scope="row">Customer:</th>
            <td>{%id_tag tx.customer%}</td>
        </tr>

        {%if tx.reference_class%}
        <tr>
            <th>Object:</th>
            <td>
                {## Allow apps to easily override this (i.e. with a link or additional info) ##}
                {%include 'cashnet/transaction/_cn_tx_object_reference_detail.html' with tx=tx%}
            </td>
        </tr>
        {%endif%}
        <tr>
            <th>Items:</th>
            <td>
                <table>
                    {%for ii in tx.items%}
                    <tr>
                        <td class="number">{{forloop.counter}}.</td>
                        <td>
                            <span title="{{ii.catalog_item.item_code}}">{{ii.catalog_item.description}}</span>
                            {%if ii.qty > 1%}
                                <br />
                                <div style="text-align:right;font-style:italic;">
                                    {{ii.qty}} @ {%format_currency ii.purchase_amount%}
                                </div>

                            {%endif%}
                        </td>
                        <td class="number">{%format_currency ii.purchase_qty_amount%}</td>
                    </tr>
                    {%endfor%}

                    <tr>
                        <td class="code" style="border-top: 1px dotted #000"></td>
                        <td style="border-top: 1px dotted #000">Total</td>
                        <td class="number" style="border-top: 1px dotted #000">{%format_currency tx.total_amount%}</td>
                    </tr>
                </table>
            </td>
        </tr>


        <tr>
            <th>Transaction Status</th>
            <td>
                {%if tx.status_code == 'N'%}
                    <span class="alert alert-warning alert-status">{{tx.status_desc}}</span>
                    <span class="note-status">This transaction was never sent to Cashnet, most likely due to an error.</span>
                {%elif tx.status_code == 'I'%}
                    <span class="alert alert-warning alert-status">{{tx.status_desc}}</span>
                    <span class="note-status">This transaction never returned from Cashnet. Payment may or may not have been completed.</span>
                {%elif tx.status_code == 'F'%}
                    <span class="alert alert-danger alert-status">{{tx.status_desc}}</span>
                    <span class="note-status">{{tx.cashnet_result_message|default:'No "result" message from Cashnet'}}</span>
                    {%if tx.cashnet_error_message%}
                        <div class="alert alert-danger">{{tx.cashnet_error_message}}</div>
                    {%endif%}
                {%elif tx.status_code == 'S'%}
                    <span class="alert alert-success alert-status">{{tx.status_desc}}</span>
                    <span class="note-status">{{tx.cashnet_result_message|default:'No "result" message from Cashnet'}}</span>
                {%else%}
                    <span class="alert alert-info">{{tx.status_desc}}</span>
                    <span class="note-status"></span>
                {%endif%}
            </td>
        </tr>
        {%if tx.post_processing_status%}
        <tr>
            <th>Post-Processing Status:</th>
            <td>
                {{tx.post_processing_status}}
            </td>
        </tr>
        {%endif%}

        {%if tx.internal_error_message%}
        <tr>
            <th>WMT Error:</th><td style="color:Maroon;">{{tx.internal_error_message}}</td>
        </tr>
        {%endif%}

        {%if can_update%}
        <tr>
            <th>Update Status:</th>
            <td>
                {%if can_proxy%}
                    <b>{%fa fa-cog fa-fw%} Update and Process Request</b><br />
                    <em>This will kick-off any post-payment processing that is required.</em><br />
                    {%if is_proxied%}
                        <a class="btn btn-success" href="{%url 'cashnet:admin_update' tx.id 'S'%}">Mark as Paid</a>
                        <a class="btn btn-danger" href="{%url 'cashnet:admin_update' tx.id 'F'%}">Mark as Unpaid</a>
                    {%elif can_proxy%}
                        <em>
                            <div class="well">
                                <b>You must proxy the customer in order to perform post-processing steps.</b><br />
                                <ol>
                                    <li>Click on your photo in the upper-right corner</li>
                                    <li>Click "Select a Proxy"</li>
                                    <li>
                                        Enter <span class="code">{{tx.customer_username}}</span> in the text field
                                    </li>
                                    <li>Hit the Enter key. This page will refresh.</li>
                                </ol>
                            </div>
                        </em>
                    {%endif%}
                    <br />
                    <br />
                {%endif%}

                {%if 'cashnet'|has_authority:True%}
                    <b>{%fa fa-wrench fa-fw%} Update Transaction Status Only</b><br />
                    <em>No post-payment processing will be done.</em><br />
                    <div class="well">
                        <form method="post" action="{%url 'cashnet:change_tx_status' tx.id%}" style="max-width:300px;">
                            {%csrf_token%}
                            <label for="status_input" class="sr-only">New Status</label>
                            <div class="input-group mb-3">
                              {%select_menu id="status_input" name="status" options=tx.status_options value=tx.status_code class="form-control"%}
                              <div class="input-group-append">
                                <button type="submit" class="btn btn-success btn-sm">Submit</button>
                              </div>
                            </div>
                        </form>
                    </div>
                    You may change the status of this transaction.
                    Note that no post-payment processing will happen when updated in this manner.

                    <br />
                    <br />
                {%endif%}
            </td>
        </tr>
        {%endif%}
        <tr>
            <th>Created:</th><td>{{tx.date_created}}</td>
        </tr>
        <tr>
            <th>Sent to Cashnet:</th><td>{{tx.initiation_date|default:'Never'}}</td>
        </tr>
        <tr>
            <th>Returned from Cashnet:</th><td>{{tx.response_date|default:'Never'}}</td>
        </tr>
        <tr>
            <th>Last Update:</th><td>{{tx.last_updated}}</td>
        </tr>


        <tr>
            <th>Cashnet URL:</th>
            <td>{{tx.cashnet_url}}</td>
        </tr>

        {%if tx.result_parameters%}
        <tr>
            <th>Cashnet Response:</th>
            <td>{{tx.result_parameters}}</td>
        </tr>
        {%endif%}

        <tr>
            <th>Cashnet Transaction Info</th>
            <td>
                {%if tx.response_date%}
                    Result: {{tx.cashnet_result_code}}<br />
                    Transaction: {{tx.cashnet_transaction}}<br />
                    Batch: {{tx.cashnet_batch}}<br />
                {%else%}
                    N/A
                {%endif%}
            </td>
        </tr>

        {%if audits%}

            <tr>
                <th>Audit Events</th>
                <td>
                    <div class="list-group">
                    {%for aa in audits%}
                        <div class="list-group-item"><br />
                            <span class="code">{{aa.event_code}}</span><br />
                            {{aa.username}}<br />
                            {{aa.date_created|date:"DATETIME_FORMAT"}}<br />
                            {{aa.comments}}<br />
                            "{{aa.previous_value}}" -> "{{aa.new_value}}"<br />
                        </div>
                    {%endfor%}
                    </div>
                </td>
            </tr>

        {%endif%}

    </table>

    <style>
        .alert-status {
            display: inline-block;
            padding: 5px 7px;
            width: 300px;
            text-align: center;
        }
        .note-status {
            display: block;
            margin-top: 5px;
            font-style: italic;
            color: #555;
        }
    </style>

    {% endblock %}
</body>
</html>