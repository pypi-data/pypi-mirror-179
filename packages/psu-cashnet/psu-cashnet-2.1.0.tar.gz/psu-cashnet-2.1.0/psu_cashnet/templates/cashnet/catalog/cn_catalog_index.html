{% extends 'psu_base/layout/main.html' %}
{% load base_taglib %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{%block title%}Cashnet Item Catalog{%endblock%}}</title>
    {% block scripts %}
        {%datatables%}
    {% endblock %}
</head>
<body>

    {% block breadcrumbs %}
        <a href="{%url 'cashnet:catalog_index'%}" class="active">Item List</a>
        &nbsp; | &nbsp;
        <a href="{%url 'cashnet:catalog_edit' 0%}">
            {%fa fa-plus-circle%}
            New Item
        </a>
    {% endblock %}
    {% block pagecontent %}

    <h1>Cashnet Catalog</h1>

    <table class="table table-striped table-hover table-condensed" id="catalog_table">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Description</th>
                <th scope="col">Item Code</th>
                <th scope="col">Cashnet Code</th>
                <th scope="col">Normal Price</th>
                <th scope="col">Sale Price</th>
                <th scope="col">Sale Start</th>
                <th scope="col">Sale End</th>
                <th scope="col">GL Code</th>
                <th scope="col"><span class="sr-only">Actions</span></th>
            </tr>
        </thead>
        <tbody>
        {%for ii in items%}
            <tr>
                <td><a href="{%url 'cashnet:catalog_edit' ii.id%}">{{ii.id}}</a></td>
                <td>
                    <label class="sr-only" for="description-{{ii.id}}">{{ii.item_code}} Description</label>
                    <input type="text" class="form-control" id="description-{{ii.id}}" value="{{ii.description|default:''}}" onchange="update_catalog_item($(this));" />
                </td>
                <td>
                    <label class="sr-only" for="description-{{ii.id}}">{{ii.item_code}} Item Code</label>
                    <input type="text" class="form-control" id="item_code-{{ii.id}}" value="{{ii.item_code|default:''}}" onchange="update_catalog_item($(this));" />
                </td>
                <td>
                    <label class="sr-only" for="cashnet_code-{{ii.id}}">{{ii.item_code}} Cashnet Code</label>
                    <input type="text" class="form-control" id="cashnet_code-{{ii.id}}" value="{{ii.cashnet_code|default:''}}" onchange="update_catalog_item($(this));" />
                </td>
                <td class="number">
                    {%if ii.is_on_sale%}
                        <s class="text-muted">{{ii.amount_description}}%</s>
                    {%else%}
                        <label class="sr-only" for="amount-{{ii.id}}">{{ii.item_code}} Amount</label>
                        <input type="text" class="form-control" id="amount-{{ii.id}}" value="{{ii.amount_description}}" onchange="update_catalog_item($(this));" />
                    {%endif%}
                </td>
                <td class="number">
                    {%if ii.is_on_sale%}
                        {%if ii.sale_end_date%}
                            {%fa fa-hourglass-half fa-fw title=ii.sale_date_notice%}
                        {%endif%}
                        <b class="text-danger">{% format_currency ii.sale_amount %}</b>
                    {%elif ii.is_future_sale%}
                        {%fa fa-clock-o fa-fw class="text-muted"  title=ii.sale_date_notice%}
                        <em class="text-muted">{% format_currency ii.sale_amount %}</em>
                    {%elif ii.is_past_sale%}
                        {%fa fa-hourglass-end fa-fw class="text-muted" title=ii.sale_date_notice%}
                        <s class="text-muted">{% format_currency ii.sale_amount %}</s>
                    {%else%}
                        <span class="text-muted">{% format_currency ii.sale_amount %}</span>
                    {%endif%}
                </td>
                <td>{{ii.sale_start_date|default:''}}</td>
                <td>{{ii.sale_end_date|default:''}}</td>
                <td>{{ii.gl|default:''}}</td>
                <td>
                    <a href="{%url 'cashnet:catalog_edit' ii.id%}">{%fa fa-pencil-square-o fa-fw title="Edit this item"%}</a>
                </td>
            </tr>
        {%endfor%}
        </tbody>
    </table>
    <em class="text-info">
        Use the {%fa fa-pencil-square-o fa-fw title="Edit this item"%} icon to modify sale prices.
    </em><br />
    <br />

    <a href="{%url 'cashnet:catalog_edit' 0%}" class="btn btn-success">
        {%fa fa-plus-circle%}
        New Item
    </a>


    <script type="text/javascript">
        function update_catalog_item(input){
            let id = input.attr('id');
            let pieces = id.split('-');
            let property = pieces[0];
            let item_id = pieces[1];
            let value = input.val();
            $.ajax({
                type:   "POST",
                url:    "{%url 'cashnet:catalog_update'%}",
                data:   {
                    property: property, item_id: item_id, value: value,
                    csrfmiddlewaretoken: '{{csrf_token}}'
                },
                beforeSend:function(){
                    clearAjaxStatusClasses(input.parent());
                    input.addClass('ajax-pending');
                    input.after(getAjaxLoadImage());
                },
                success:function(data){
                    input.addClass('ajax-success');
                    input.val(data);
                },
                error:function(){
                    input.addClass('ajax-error');
                },
                complete:function(){
                    clearAjaxLoadImage(input.parent());
                    input.removeClass('ajax-pending');
                }
            });
        }

        $(document).ready(function() {
            var application_table = $('#catalog_table').DataTable( {
                "pageLength": 50,
                "pagingType": "full_numbers"
            } );
            //Focus on the search box on page load
            $('#catalog_table_filter').find('input[type=search]').focus();
        } );
    </script>
    {% endblock %}
</body>
</html>